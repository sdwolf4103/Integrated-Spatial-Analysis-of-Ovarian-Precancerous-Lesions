---
title: "1_STIC_Nanostring_preprocessing"
output: html_notebook
---

# Data preprocessing

## ---- Setup (renv + packages) --------------------------------
```{r message=FALSE, warning=FALSE}
# Activate project library if present
if (file.exists("renv/activate.R")) source("renv/activate.R")

# Install CRAN/Bioc deps into current lib if missing
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

cran_pkgs <- c("dplyr","readxl","openxlsx","data.table","ggplot2",
               "ggrepel","RColorBrewer","viridis","psych")
bioc_pkgs <- c("DESeq2","sva","Biobase","limma","edgeR","SummarizedExperiment")

need_cran <- cran_pkgs[!vapply(cran_pkgs, requireNamespace, logical(1), quietly = TRUE)]
need_bioc <- bioc_pkgs[!vapply(bioc_pkgs, requireNamespace, logical(1), quietly = TRUE)]

if (length(need_cran)) install.packages(need_cran)
if (length(need_bioc)) BiocManager::install(need_bioc, ask = FALSE, update = TRUE)

suppressPackageStartupMessages({
  library(dplyr); library(readxl); library(ggplot2); library(data.table)
  library(psych); library(DESeq2); library(sva); library(openxlsx)
  library(Biobase); library(limma); library(viridis); library(RColorBrewer)
  library(edgeR); library(ggrepel)
})
```


## –– 0) Project roots & folders ––––––––––––––––
```{r}
root           <- "/Users/sd_wo/Documents/projects/nanostring-paper-code"
data_dir       <- normalizePath(file.path(root, "data", "raw"), mustWork = TRUE)
data_processed <- normalizePath(file.path(root, "data", "processed"), mustWork = FALSE)
rdata_dir      <- file.path(data_processed, "Rdata")
fig_dir        <- file.path(root, "outputs", "figures", "01_preprocess")

dir.create(data_processed, recursive = TRUE, showWarnings = FALSE)
dir.create(rdata_dir,     recursive = TRUE, showWarnings = FALSE)
dir.create(fig_dir,       recursive = TRUE, showWarnings = FALSE)

message("root:      ", root)
message("data_dir:  ", data_dir)
message("rdata_dir: ", rdata_dir)
message("fig_dir:   ", fig_dir)

# Optional: if you still have custom helpers, load them (won't error if missing)
geo_fn <- file.path(root, "script", "GeoMx_Project_Custom_Functions.R")
if (file.exists(geo_fn)) source(geo_fn)
```


```{r}
# Count data (now directly under data/raw/)
Batch_1   <- read_excel(file.path(data_dir, "1st batch (Nanostring).xlsx"),                         sheet = 3)
Batch_2   <- read_excel(file.path(data_dir, "2nd batch (All Data WTA).xlsx"),                       sheet = 3)
Batch_3_1 <- read_excel(file.path(data_dir, "3rd batch_1 (All Data WTA_M1140b_G0146).xlsx"),        sheet = 3)
Batch_3_2 <- read_excel(file.path(data_dir, "3rd batch_2 (All Data WTA_M1140b_G0073).xlsx"),               sheet = 3)
Batch_3_3 <- read_excel(file.path(data_dir, "3rd batch_3 (All Data WTA_M1140b_G0073_ExtraSlide).xlsx"), sheet = 3)

# Annotation data (sheet 1 of the same files)
Batch_1_qc   <- read_excel(file.path(data_dir, "1st batch (Nanostring).xlsx"),                         sheet = 1)
Batch_2_qc   <- read_excel(file.path(data_dir, "2nd batch (All Data WTA).xlsx"),                       sheet = 1)
Batch_3_1_qc <- read_excel(file.path(data_dir, "3rd batch_1 (All Data WTA_M1140b_G0146).xlsx"),        sheet = 1)
Batch_3_2_qc <- read_excel(file.path(data_dir, "3rd batch_2 (All Data WTA_M1140b_G0073).xlsx"),               sheet = 1)
Batch_3_3_qc <- read_excel(file.path(data_dir, "3rd batch_3 (All Data WTA_M1140b_G0073_ExtraSlide).xlsx"), sheet = 1)

# Metadata
nanostring_metadata <- read_excel(file.path(data_dir, "Nanostring_metadata.xlsx"), sheet = 1)
```

### Adjust column names in gene count data
```{r}
colnames(Batch_1) <- gsub(".|.", " | ", colnames(Batch_1), fixed = TRUE)
colnames(Batch_1) <- gsub("-", "", colnames(Batch_1), fixed = TRUE)
colnames(Batch_2) <- gsub("|", " | ", colnames(Batch_2), fixed = TRUE)
colnames(Batch_2) <- gsub(".", " ", colnames(Batch_2), fixed = TRUE)
colnames(Batch_3_1) <- gsub("|", " | ", colnames(Batch_3_1), fixed = TRUE)
colnames(Batch_3_1) <- gsub(".", " ", colnames(Batch_3_1), fixed = TRUE)
colnames(Batch_3_2) <- gsub("|", " | ", colnames(Batch_3_2), fixed = TRUE)
colnames(Batch_3_2) <- gsub(".", " ", colnames(Batch_3_2), fixed = TRUE)
colnames(Batch_3_3) <- gsub("|", " | ", colnames(Batch_3_3), fixed = TRUE)
colnames(Batch_3_3) <- gsub(".", " ", colnames(Batch_3_3), fixed = TRUE)
```

### Adjust SegmentDisplayName in annotation data (Batch_1_qc):
```{r}
Batch_1_qc$SegmentDisplayName <- gsub('.', ' ', Batch_1_qc$SegmentDisplayName, fixed = TRUE)
Batch_1_qc$SegmentDisplayName <- gsub('-', '', Batch_1_qc$SegmentDisplayName, fixed = TRUE)
```

### Merge data:
```{r}
# Count data
merged <- Reduce(function(x, y) merge(x, y, by = "TargetName", all = TRUE), list(Batch_1, Batch_2, Batch_3_1, Batch_3_2, Batch_3_3))
row.names(merged) <- merged$TargetName
count_data <- dplyr::select(merged, -TargetName)

# Annotation data
Batch_2_qc_sub <- dplyr::select(Batch_2_qc, -Origin.Instrument.ID)
merged_qc <- bind_rows(dplyr::select(Batch_1_qc, names(Batch_2_qc_sub)), Batch_2_qc_sub)

batch_list <- lapply(list(Batch_3_1_qc, Batch_3_2_qc, Batch_3_3_qc), function(batch) dplyr::select(batch, -Origin.Instrument.ID))
merged_qc <- bind_rows(merged_qc, bind_rows(batch_list))

anno_data <- merge(merged_qc, nanostring_metadata, by = "SegmentDisplayName")

```

### Order count_data as anno_data 
```{r}
rownames(anno_data) <- anno_data$SegmentDisplayName
metadata_row_names <- row.names(anno_data)[match(colnames(count_data), row.names(anno_data))]
count_data <- count_data[, row.names(anno_data)]

# Check if the order is the same
all(colnames(count_data) %in% row.names(anno_data))
all(colnames(count_data) == row.names(anno_data))
```

### Save merged count data and annotation data
```{r}
write.xlsx(count_data, file = file.path(rdata_dir, "count_data.xlsx"), rowNames = TRUE)
write.xlsx(anno_data,  file = file.path(rdata_dir, "anno_data_qc.xlsx"),  rowNames = FALSE)
```

## Five percentage filtering
### Read count_data
```{r message=FALSE, warning=FALSE}
count_data <- read_excel(file.path(rdata_dir, "count_data_WTA.xlsx")) %>% as.data.frame()
rownames(count_data) <- count_data[[1]]
count_data <- count_data[, -1]
```

### Functions 
```{r}
geomean <- function(x) exp(mean(log(as.numeric(x))))
geosd   <- function(x) exp(sd(log(as.numeric(x))))
LOQ <- function(a_matrix) {
  neg_idx <- which(rownames(a_matrix) %in% "NegProbe-WTX")
  if (length(neg_idx) != 1) stop("Could not locate a single 'NegProbe-WTX' row.")
  neg <- a_matrix[neg_idx, ]
  geomean(neg) * geosd(neg)^2
}
loqfilter <- function(data, min_rois) {
  m <- as.matrix(data)
  loq <- LOQ(m)
  keep_counts <- apply(m, 1, function(row) sum(row > loq))
  m[keep_counts > min_rois, , drop = FALSE]
}
Q3Normalization <- function(a) {
  q3s <- apply(a, 2, function(col) stats::quantile(col, 0.75))
  scaled <- sweep(a, 2, q3s, "/")
  scaled * exp(mean(log(q3s)))
}
```


### Five percentage filtering and save as filtered_count_data.xlsx
```{r}
filtered <- loqfilter(count_data, 23) # 5%
write.xlsx(filtered, file = file.path(rdata_dir, "filtered_count_data.xlsx"), rowNames = TRUE)
```


## Q3 normalization
### Load filtered_count_data and anno_data, Q3 normalization and save as q3_count_data.xlsx (not use eventually)
```{r message=FALSE, warning=FALSE}
filtered <- read_xlsx(file.path(rdata_dir, "filtered_count_data.xlsx")) %>% as.data.frame()
rownames(filtered) <- filtered[[1]]
filtered <- filtered[, -1]

q3_normalized <- Q3Normalization(as.matrix(filtered))
write.xlsx(q3_normalized, file = file.path(rdata_dir, "q3_count_data.xlsx"), rowNames = TRUE)
```



## Variance stabilizing transformation
### Load filtered_count_data 
```{r message=FALSE, warning=FALSE}
count_data <- read_xlsx(file.path(rdata_dir, "filtered_count_data.xlsx")) %>%
  as.data.frame() %>% {rownames(.) <- .[[1]]; .} %>% dplyr::select(-1) %>% as.matrix() %>% round()

anno_data <- read_xlsx(file.path(rdata_dir, "anno_data_qc.xlsx")) %>% as.data.frame()
rownames(anno_data) <- anno_data$SegmentDisplayName

# keep col/row alignment
stopifnot(all(colnames(count_data) == rownames(anno_data)))
```

### Make dds + VST
```{r message=FALSE, warning=FALSE}
dds <- DESeqDataSetFromMatrix(countData = count_data,
                              colData = anno_data,
                              design = ~ batch + type + Diagnosis)

vsd <- assay(vst(dds, blind = FALSE))
vsd <- as.data.frame(vsd)
write.xlsx(vsd, file = file.path(rdata_dir, "vst.xlsx"), rowNames = TRUE)
```


### Batch correction with ComBat and ComBat_seq
```{r}
count_log <- log2(count_data + 1)
batch_adjusted_combat    <- sva::ComBat(dat = count_log, batch = anno_data$batch)
batch_adjusted_combatseq <- sva::ComBat_seq(count_data,  batch = anno_data$batch)

batch_adjusted_combat    <- as.data.frame(batch_adjusted_combat)
batch_adjusted_combatseq <- as.data.frame(batch_adjusted_combatseq)

sum(batch_adjusted_combat < 0)       # e.g., 1254
any(batch_adjusted_combatseq < 0)    # FALSE

write.xlsx(batch_adjusted_combat,    file = file.path(rdata_dir, "combat.xlsx"),    rowNames = TRUE)
write.xlsx(batch_adjusted_combatseq, file = file.path(rdata_dir, "combatseq.xlsx"), rowNames = TRUE)
```

### limma::removeBatchEffect()
```{r}
log_cpm <- cpm(dds, log = TRUE)
log_cpm_corrected <- limma::removeBatchEffect(log_cpm, batch = anno_data$batch)
any(log_cpm_corrected < 0)

log_cpm_corrected <- as.data.frame(log_cpm_corrected)
write.xlsx(log_cpm_corrected, file = file.path(rdata_dir, "limma.xlsx"), rowNames = TRUE)
```

## Plot PCA
### PCA plot function
```{r}
perform_pca_type_batch <- function(count_data, anno_data, log = FALSE) {
  if (log) {
    comp <- prcomp(log2(count_data))
  } else {
    comp <- prcomp(count_data)
  }
  table <- subset(comp$rotation, select = c(PC1, PC2))
  dtable <- cbind(table, anno_data)
  variance_explained <- summary(comp)$importance[3, ]
  
  pca_type <- ggplot(dtable, aes(x = PC1, y = PC2, color = type)) +
    geom_point(size = 3) +
    scale_color_manual(name = "Tissue type",
                       labels = c("Epithelium", "Mesothelium", "Stroma"),
                       values = c("firebrick3", "olivedrab3", "royalblue1")) +
    labs(x = paste0("PC1: ", round(variance_explained[1], 2) * 100, "% variance"),
         y = paste0("PC2: ", round(variance_explained[2] - variance_explained[1], 2) * 100, "% variance")) +
    theme_bw()
  
  unique_batches <- unique(dtable$batch)
  pca_batch <- ggplot(dtable, aes(x = PC1, y = PC2, color = batch)) +
    geom_point(size = 3) +
    scale_color_manual(name = "Batch",
                       values = c("royalblue3","firebrick3","green4","hotpink","orange",
                                  "khaki2","skyblue","magenta4","cyan3","coral4")) +
    labs(x = paste0("PC1: ", round(variance_explained[1], 2) * 100, "% variance"),
         y = paste0("PC2: ", round(variance_explained[2] - variance_explained[1], 2) * 100, "% variance")) +
    theme_bw()
  
  list(pca_type = pca_type, pca_batch = pca_batch)
}
```


### PCA without Batch correction
```{r}
original_pca_plots <- perform_pca_type_batch(count_data, anno_data, log = TRUE)
original_pca_plots$pca_type
original_pca_plots$pca_batch

ggsave(file.path(fig_dir, "PCA_original_type.png"),  plot = original_pca_plots$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_original_batch.png"), plot = original_pca_plots$pca_batch, width = 9, height = 6, dpi = 300)
```

### PCA with VST
```{r message=FALSE, warning=FALSE}
vsd <- read_xlsx(file.path(rdata_dir, "vst.xlsx")) %>%
       as.data.frame() %>% {rownames(.) <- .[[1]]; .} %>% dplyr::select(-1) %>% as.matrix()

vst_pca_plots <- perform_pca_type_batch(vsd, anno_data, log = TRUE)
vst_pca_plots$pca_type
vst_pca_plots$pca_batch

ggsave(file.path(fig_dir, "PCA_vst_type.png"),  plot = vst_pca_plots$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_vst_batch.png"), plot = vst_pca_plots$pca_batch, width = 9, height = 6, dpi = 300)
```

### PCA with batch correction
#### Combat
```{r}
batch_adjusted <- read_xlsx(file.path(rdata_dir, "combat.xlsx")) %>%
       as.data.frame() %>% {rownames(.) <- .[[1]]; .} %>% dplyr::select(-1) %>% as.matrix()

batch_adjusted_positive <- batch_adjusted
batch_adjusted_positive[batch_adjusted_positive < 0] <- 0

combat_pca_plots <- perform_pca_type_batch(batch_adjusted_positive, anno_data, log = FALSE)
combat_pca_plots$pca_type
combat_pca_plots$pca_batch

ggsave(file.path(fig_dir, "PCA_combat_type.png"),  plot = combat_pca_plots$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_combat_batch.png"), plot = combat_pca_plots$pca_batch, width = 9, height = 6, dpi = 300)

```
#### Combat_seq
```{r}
batch_adjusted_combatseq <- read_xlsx(file.path(rdata_dir, "combatseq.xlsx")) %>%
       as.data.frame() %>% {rownames(.) <- .[[1]]; .} %>% dplyr::select(-1) %>% as.matrix()

combatseq_pca_plots <- perform_pca_type_batch(batch_adjusted_combatseq, anno_data, log = FALSE)
combatseq_pca_plots$pca_type
combatseq_pca_plots$pca_batch

log_batch_adjusted_combatseq <- batch_adjusted_combatseq + 1
log_combat_seq_pca_plots <- perform_pca_type_batch(log_batch_adjusted_combatseq, anno_data, log = TRUE)
log_combat_seq_pca_plots$pca_type
log_combat_seq_pca_plots$pca_batch

ggsave(file.path(fig_dir, "PCA_combatseq_type.png"),  plot = log_combat_seq_pca_plots$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_combatseq_batch.png"), plot = log_combat_seq_pca_plots$pca_batch, width = 9, height = 6, dpi = 300)

```

#### PCA with batch correction — limma
```{r}
limma_mat <- read_xlsx(file.path(rdata_dir, "limma.xlsx")) %>%
       as.data.frame() %>% {rownames(.) <- .[[1]]; .} %>% dplyr::select(-1) %>% as.matrix()

limma_pca_plots <- perform_pca_type_batch(limma_mat, anno_data, log = FALSE)
limma_pca_plots$pca_type
limma_pca_plots$pca_batch

ggsave(file.path(fig_dir, "PCA_limma_type.png"),  plot = limma_pca_plots$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_limma_batch.png"), plot = limma_pca_plots$pca_batch, width = 9, height = 6, dpi = 300)

```

#### VST -> Combat
```{r}
vst_mat <- vsd  # already loaded above for PCA-VST
vst_combat <- sva::ComBat(dat = vst_mat, batch = anno_data$batch)
vst_combat <- as.data.frame(vst_combat)
write.xlsx(vst_combat, file = file.path(rdata_dir, "vst_combat.xlsx"), rowNames = TRUE)

sum(vst_combat < 0)

vst_combat_pos <- vst_combat
vst_combat_pos[vst_combat_pos < 0] <- 0

vst_combat_pca <- perform_pca_type_batch(vst_combat_pos, anno_data, log = FALSE)
vst_combat_pca$pca_type
vst_combat_pca$pca_batch

ggsave(file.path(fig_dir, "PCA_vst_combat_type.png"),  plot = vst_combat_pca$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_vst_combat_batch.png"), plot = vst_combat_pca$pca_batch, width = 9, height = 6, dpi = 300)
```

#### Combatseq -> VST
```{r message=FALSE, warning=FALSE}
dds_combatseq <- DESeqDataSetFromMatrix(countData = batch_adjusted_combatseq,
                                        colData   = anno_data,
                                        design    = ~ batch + type + Diagnosis)
combatseq_vst <- assay(vst(dds_combatseq, blind = FALSE)) %>% as.data.frame()
write.xlsx(combatseq_vst, file = file.path(rdata_dir, "combatseq_vst.xlsx"), rowNames = TRUE)

sum(combatseq_vst < 0)

combatseq_vst_pca <- perform_pca_type_batch(combatseq_vst, anno_data, log = FALSE)
combatseq_vst_pca$pca_type
combatseq_vst_pca$pca_batch

ggsave(file.path(fig_dir, "PCA_combatseq_vst_type.png"),  plot = combatseq_vst_pca$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_combatseq_vst_batch.png"), plot = combatseq_vst_pca$pca_batch, width = 9, height = 6, dpi = 300)
```

### VST -> limma::removeBatchEffect()
```{r}
vst_limma <- limma::removeBatchEffect(vst_mat, batch = anno_data$batch) %>% as.data.frame()
write.xlsx(vst_limma, file = file.path(rdata_dir, "vst_limma.xlsx"), rowNames = TRUE)
sum(vst_limma < 0)

vst_limma_pos <- vst_limma
vst_limma_pos[vst_limma_pos < 0] <- 0

vst_limma_pca <- perform_pca_type_batch(vst_limma_pos, anno_data, log = FALSE)
vst_limma_pca$pca_type
vst_limma_pca$pca_batch

ggsave(file.path(fig_dir, "PCA_vst_limma_type.png"),  plot = vst_limma_pca$pca_type,  width = 9, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PCA_vst_limma_batch.png"), plot = vst_limma_pca$pca_batch, width = 9, height = 6, dpi = 300)
```
### kBET for batch effect evaluation
```{r}
if (requireNamespace("kBET", quietly = TRUE) && requireNamespace("gridExtra", quietly = TRUE)) {
  library(kBET); library(gridExtra)

  plot_kBET_results <- function(kBET_data, x_label = "Test", y_label = "Rejection rate") {
    plot.data <- data.frame(class = rep(c('observed','expected'),
                                        each = length(kBET_data$stats$kBET.observed)),
                            data  = c(kBET_data$stats$kBET.observed,
                                      kBET_data$stats$kBET.expected))
    ggplot(plot.data, aes(class, data, fill = class)) +
      geom_boxplot(alpha = 0.7, outlier.shape = NA) +
      labs(x = x_label, y = y_label, title = 'kBET test results') +
      theme_minimal() + scale_y_continuous(limits = c(0,1)) +
      scale_fill_manual(values = c("#1f78b4","#33a02c"), name = "Class",
                        labels = c("Observed","Expected")) +
      theme(legend.position = "top")
  }

  plot_multiple_kBET_results <- function(kBET_list, titles) {
    blank_plot <- ggplot() + theme_void()
    insert_blank <- function(lst, index, value) c(lst[1:index], list(value), lst[(index+1):length(lst)])
    plots <- insert_blank(lapply(seq_along(kBET_list), function(i) {
      p <- plot_kBET_results(kBET_list[[i]]) + ggtitle(titles[i]); p
    }), 2, blank_plot)
    do.call(gridExtra::grid.arrange, c(plots, ncol = 3))
  }

  batch.estimate_orignial    <- kBET(log2(count_data + 1),        anno_data$batch)
  batch.estimate_combat      <- kBET(batch_adjusted,               anno_data$batch)
  batch.estimate_combatseq   <- kBET(log2(batch_adjusted_combatseq + 1), anno_data$batch)
  batch.estimate_vst         <- kBET(vsd,                          anno_data$batch)
  batch.estimate_limma       <- kBET(limma_mat,                    anno_data$batch)
  batch.estimate_vst_combat  <- kBET(as.matrix(vst_combat),        anno_data$batch)
  batch.estimate_combatseq_vst <- kBET(as.matrix(combatseq_vst),   anno_data$batch)
  batch.estimate_vst_limma   <- kBET(as.matrix(vst_limma),         anno_data$batch)

  kBET_list <- list(batch.estimate_orignial, batch.estimate_vst,
                    batch.estimate_combatseq, batch.estimate_combat,
                    batch.estimate_limma, batch.estimate_vst_combat,
                    batch.estimate_combatseq_vst, batch.estimate_vst_limma)
  titles <- c("Original","VST","Combat_seq(log)","Combat(log)","Limma","VST→Combat","Combat_seq→VST","VST→Limma")

  kBET_multiplot <- plot_multiple_kBET_results(kBET_list, titles)
  ggsave(file.path(fig_dir, "k-BET_plot.png"), plot = kBET_multiplot, width = 8.3, height = 8.6)
} else {
  message("kBET/gridExtra not installed; skipping kBET panel.")
}

```



